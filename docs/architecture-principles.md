# Принципы разделения функционала и архитектуры

Документ описывает ключевые принципы архитектуры проекта, которые должны соблюдаться при разработке и масштабировании системы.

**Важно для агентов:** Перед любыми изменениями кода обязательно ознакомьтесь с этими принципами и убедитесь, что изменения им соответствуют.

---

## Принцип 1: Разделение по приложениям Fly.io (ОБЯЗАТЕЛЬНО)

### Описание
- **БД и API для работы с БД** → отдельное приложение (abc-metrics)
- **Сервисы синхронизации** → отдельное приложение (rely-lead-processor)
- Каждое приложение может быть в отдельном git репозитории
- Приложения общаются только через HTTP API

### Критичные требования
- **КРИТИЧНО:** БД доступна ТОЛЬКО через API, никаких прямых подключений из других приложений
- Прямое подключение к БД из сервисов синхронизации ЗАПРЕЩЕНО
- Все операции с БД должны проходить через REST API

**Важное уточнение:**
- **`abc-metrics`** - это DB API приложение, которое **МОЖЕТ и ДОЛЖНО** использовать прямое подключение к БД через `DATABASE_URL` и `pool` из библиотеки `pg`. Это правильно, так как `abc-metrics` - это приложение для работы с БД.
- **`rely-lead-processor`** - это приложение синхронизации, которое **НЕ ДОЛЖНО** использовать прямое подключение к БД. Все операции с БД должны проходить через REST API `abc-metrics` с использованием `AbcMetricsClient`.
- Переменная окружения `DATABASE_URL` **ТРЕБУЕТСЯ** в `abc-metrics` для прямого подключения к БД.
- Переменная окружения `DATABASE_URL` **НЕ ТРЕБУЕТСЯ** в `rely-lead-processor` для модуля метрик (используется `ABC_METRICS_API_URL` и `ABC_METRICS_API_KEY`).

### Преимущества
- БД масштабируется независимо от сервисов синхронизации
- Можно увеличить ресурсы БД без изменения приложений-сервисов
- Изоляция: падение сервиса синхронизации не влияет на БД
- Безопасность: единая точка доступа к БД с контролем доступа

### Примеры
- ✅ Правильно: `rely-lead-processor` вызывает `POST https://abc-metrics.fly.dev/api/db/jobs` для сохранения данных через `AbcMetricsClient`
- ❌ Неправильно: `rely-lead-processor` подключается напрямую к `DATABASE_URL` из abc-metrics
- ✅ Правильно: `abc-metrics` использует `DATABASE_URL` и `pool` из `pg` для прямого подключения к БД
- ❌ Неправильно: `abc-metrics` пытается использовать REST API для работы с собственной БД (избыточно)

---

## Принцип 2: Изоляция функционала в одном приложении (ОБЯЗАТЕЛЬНО)

### Описание
Если в одном приложении несколько функционалов (например, метрики + парсеры email), они должны быть полностью изолированы друг от друга.

### Обязательные требования
1. **ОБЯЗАТЕЛЬНО:** Использовать отдельные директории/модули для каждого функционала
   - Пример: `src/metrics/` для метрик, `src/email/` для парсеров email
   - Каждый модуль должен быть самодостаточным

2. **ОБЯЗАТЕЛЬНО:** Использовать префиксы для API endpoints
   - Пример: `/api/metrics/*` для метрик, `/api/email/*` для email
   - Префиксы должны быть уникальными и не пересекаться

3. **ОБЯЗАТЕЛЬНО:** Не допускать конфликтов в именах файлов, классов, функций
   - Имена должны быть уникальными в рамках всего приложения
   - Использовать префиксы в именах классов (например, `MetricsScheduler`, `EmailScheduler`)

4. **ОБЯЗАТЕЛЬНО:** Изолировать зависимости в рамках модуля
   - Зависимости модуля должны быть явно указаны в его документации
   - Изменения в зависимостях одного модуля не должны влиять на другой

5. **ОБЯЗАТЕЛЬНО:** Каждый модуль должен иметь свой `index.ts` для экспорта
   - Модуль должен экспортировать только необходимые интерфейсы
   - Интеграция модуля в главное приложение должна быть простой и явной

### Структура модуля
```
src/metrics/
├── services/     # Все сервисы метрик
│   ├── abc-metrics-client.ts
│   ├── svc-workiz-jobs.ts
│   └── ...
├── routes.ts     # API routes (префикс /api/metrics/)
├── scheduler.ts  # Планировщик задач
└── index.ts      # Экспорт модуля
```

### Примеры
- ✅ Правильно: Модуль метрик в `src/metrics/`, модуль email в `src/email/`
- ❌ Неправильно: Файлы метрик и email в одной директории `src/services/`
- ✅ Правильно: API endpoints `/api/metrics/sync/*` и `/api/email/parse/*`
- ❌ Неправильно: API endpoints `/api/sync/*` для обоих модулей

---

## Принцип 3: Независимость разработки (ОБЯЗАТЕЛЬНО)

### Описание
Разработка одного функционала НЕ ДОЛЖНА влиять на другой. Изменения должны быть изолированы.

### Обязательные требования
- Разработка одного функционала НЕ ДОЛЖНА влиять на другой
- Изменения в модулях метрик НЕ ДОЛЖНЫ затрагивать модули парсеров email
- Каждый функционал должен иметь свою документацию
- Изменения в одном модуле не должны требовать изменений в другом

### Преимущества
- Параллельная разработка разных функционалов
- Упрощение code review (изменения изолированы)
- Снижение риска регрессий
- Упрощение тестирования

### Примеры
- ✅ Правильно: Изменение `src/metrics/services/svc-workiz-jobs.ts` не требует изменений в `src/email/`
- ❌ Неправильно: Изменение метрик требует обновления файлов email парсеров

---

## Принцип 4: Масштабируемость БД

### Описание
База данных должна масштабироваться независимо от приложений-сервисов.

### Требования
- БД находится в отдельном приложении (abc-metrics)
- БД доступна ТОЛЬКО через API (никаких прямых подключений)
- БД масштабируется независимо от сервисов синхронизации
- Использовать Fly.io Managed Postgres для автоматического управления
- Можно увеличить ресурсы БД без изменения приложений-сервисов

### Преимущества
- Независимое масштабирование БД и сервисов
- Автоматическое управление ресурсами (Fly.io)
- Поддержка репликации и высокой доступности
- Оптимизация производительности БД без влияния на сервисы

### Примеры
- ✅ Правильно: Увеличение ресурсов БД в Fly.io dashboard не требует изменений в коде
- ❌ Неправильно: Изменение конфигурации БД требует обновления всех сервисов

---

## Принцип 5: Безопасность и изоляция

### Описание
Все взаимодействия между компонентами должны быть защищены и изолированы.

### Требования
- Аутентификация между приложениями через API ключи
- Изоляция сети через Fly.io
- Rate limiting для защиты API
- SSL/TLS для всех соединений
- Каждый модуль должен иметь свою аутентификацию (если требуется)

### Преимущества
- Защита от несанкционированного доступа
- Изоляция сетевого трафика
- Защита от перегрузки API
- Соответствие стандартам безопасности

### Примеры
- ✅ Правильно: API запросы требуют `X-API-Key` заголовок
- ❌ Неправильно: API доступен без аутентификации
- ✅ Правильно: Rate limiting 100 запросов в минуту
- ❌ Неправильно: Нет ограничений на количество запросов

---

## Принцип 6: Структура модуля в rely-lead-processor (ОБЯЗАТЕЛЬНО)

### Описание
Все файлы метрик должны быть организованы в отдельной директории с четкой структурой.

### Обязательные требования
- Все файлы метрик должны быть в `src/metrics/`
- Никаких файлов метрик вне директории `src/metrics/`
- Интеграция в главное приложение через `src/metrics/index.ts`

### Структура модуля
```
src/metrics/
├── services/     # Все сервисы метрик
│   ├── abc-metrics-client.ts
│   ├── svc-workiz-jobs.ts
│   ├── svc-workiz-leads.ts
│   ├── svc-workiz-payments.ts
│   ├── svc-elocal-calls.ts
│   ├── csv.service.ts
│   └── workiz.service.ts
├── routes.ts     # API routes (префикс /api/metrics/)
├── scheduler.ts  # Планировщик задач
└── index.ts      # Экспорт модуля
```

### Интеграция в главное приложение
```typescript
// src/app.ts или src/index.ts
import metricsModule from './metrics';

// Интеграция routes
app.use('/api/metrics', metricsModule.routes);

// Запуск планировщика
metricsModule.scheduler.start();
```

### Примеры
- ✅ Правильно: Все файлы метрик в `src/metrics/`
- ❌ Неправильно: Файлы метрик в `src/services/` вместе с другими сервисами
- ✅ Правильно: Интеграция через `metricsModule.routes`
- ❌ Неправильно: Прямой импорт файлов из `src/metrics/` в главном файле

---

## Проверка соответствия принципам

### Чеклист для Architect-агента
При создании архитектурного решения необходимо проверить:
- [ ] Соблюден Принцип 1: БД доступна только через API?
- [ ] Соблюден Принцип 2: Функционал изолирован в отдельной директории?
- [ ] Соблюден Принцип 2: API endpoints используют уникальные префиксы?
- [ ] Соблюден Принцип 2: Нет конфликтов в именах файлов, классов, функций?
- [ ] Соблюден Принцип 3: Изменения не затрагивают другие модули?
- [ ] Соблюден Принцип 6: Структура модуля соответствует требованиям?

### Чеклист для Implementer-агента
При реализации кода необходимо проверить:
- [ ] Все файлы находятся в правильной директории?
- [ ] API endpoints используют правильные префиксы?
- [ ] Нет конфликтов в именах?
- [ ] Модуль экспортируется через `index.ts`?
- [ ] Интеграция в главное приложение выполнена корректно?

### Чеклист для Reviewer-агента
При ревью кода необходимо проверить:
- [ ] Все принципы соблюдены?
- [ ] Нет нарушений изоляции?
- [ ] Нет конфликтов с существующим функционалом?
- [ ] Документация обновлена?

---

## Примечания

- Эти принципы должны учитываться во всех агентах проекта
- При нарушении принципов Architect-агент должен вернуть решение на доработку
- Implementer-агент должен проверять соответствие принципам перед реализацией
- Reviewer-агент должен проверять соблюдение принципов при ревью

---

## История изменений

- **2025-01-XX:** Создан документ с принципами разделения функционала и архитектуры

