Инструкция для агента по настройке views в Metabase на основе существующих данных:
# Инструкция для настройки Views в Metabase для показателей abc-metrics## Общая информацияБаза данных `abc-metrics` уже содержит готовые SQL views (представления), которые можно использовать напрямую в Metabase для создания метрик и дашбордов. Все views находятся в схеме `public` и будут доступны после синхронизации схемы в Metabase.## Доступные готовые Views### 1. Базовые Views (используйте как есть)#### `vw_daily_metrics` - Дневные метрики с конверсиями**Поля:**- `d` (DATE) - дата- `source` (VARCHAR) - источник- `segment` (VARCHAR) - сегмент (COD, INS, OTHER)- `leads` (INTEGER) - количество лидов- `units` (INTEGER) - количество units- `repairs` (INTEGER) - количество ремонтов- `net_revenue` (NUMERIC) - чистая выручка (revenue * 0.40)- `total_cost` (NUMERIC) - общая стоимость- `conv_l_u` (NUMERIC) - конверсия лид → unit- `conv_l_r` (NUMERIC) - конверсия лид → repair- `conv_u_r` (NUMERIC) - конверсия unit → repair- `cpl` (NUMERIC) - cost per lead- `cpu` (NUMERIC) - cost per unit**Использование в Metabase:**1. Выберите "Pick a table or a model"2. Найдите `vw_daily_metrics`3. Можете сразу использовать для графиков и таблиц#### `vw_monthly_metrics` - Месячные метрики**Поля:**- `month_start` (DATE) - начало месяца- `source`, `segment` - как в daily- `leads`, `units`, `repairs` - агрегированные- `net_revenue`, `cost` - агрегированные- `conv_l_u`, `conv_l_r`, `conv_u_r` - конверсии- `rev_per_lead`, `rev_per_unit`, `rev_per_repair` - выручка на единицу- `cpl`, `cpu` - cost per lead/unit#### `mart_profit_mtd` - Витрина прибыли (P&L) по дням**Поля:**- `d` (DATE) - дата- `gross_revenue` (NUMERIC) - валовая выручка из платежей- `total_expenses` (NUMERIC) - общие расходы- `net_profit` (NUMERIC) - чистая прибыль#### `mart_profit_mtd_v2` - Витрина прибыли с прогнозом**Поля:**- `month_start` (DATE) - месяц- `mtd_revenue` (NUMERIC) - выручка за месяц на текущий момент- `mtd_expenses` (NUMERIC) - расходы за месяц- `mtd_profit` (NUMERIC) - прибыль за месяц- `avg_daily_profit_14d` (NUMERIC) - средний дневной профит за 14 дней- `projected_profit` (NUMERIC) - прогнозируемая прибыль до конца месяца#### `mart_tech_mtd` - Эффективность техников**Поля:**- `technician_name` (TEXT) - имя техника- `month_start` (DATE) - месяц- `total_jobs` (INTEGER) - всего работ- `repairs_count` (INTEGER) - количество ремонтов- `gross_revenue` (NUMERIC) - выручка- `avg_revenue_per_job` (NUMERIC) - средний чек- `same_day_rate` (NUMERIC) - доля same-day ремонтов (0-1)#### `mart_zip_mtd` - Теплокарта по почтовым индексам**Поля:**- `zip` (VARCHAR) - почтовый индекс- `lat`, `lon` (NUMERIC) - координаты- `month_start` (DATE) - месяц- `job_count` (INTEGER) - количество работ- `total_revenue` (NUMERIC) - выручка#### `mart_channel_mtd` - Эффективность каналов**Поля:**- `channel_name` (TEXT) - название канала- `month_start` (DATE) - месяц- `total_leads` (INTEGER) - всего лидов- `valid_leads` (INTEGER) - валидных лидов- `total_spend` (NUMERIC) - потрачено- `diagnostics_done` (INTEGER) - диагностик выполнено- `repairs_completed` (INTEGER) - ремонтов завершено- `cost_per_valid_lead` (NUMERIC) - стоимость валидного лида- `cost_per_diagnostic` (NUMERIC) - стоимость диагностики- `cost_per_repair` (NUMERIC) - стоимость ремонта#### `mart_lead_funnel_mtd` - Воронка лидов**Поля:**- `channel_name` (TEXT) - канал- `month_start` (DATE) - месяц- `leads_total` (INTEGER) - всего лидов- `diagnostics_booked` (INTEGER) - диагностик назначено- `diagnostics_canceled` (INTEGER) - диагностик отменено- `repairs_completed` (INTEGER) - ремонтов завершено#### `stg_jobs` - Нормализованные работы**Поля:**- `job_id`, `lead_id`, `created_at`, `scheduled_at`- `technician_name`, `source_id`, `raw_type`- `job_total_price`- `zip` - извлечен из meta- `same_day_repair_flag` (BOOLEAN)- `job_category` (TEXT) - Repair/Diagnostic/Other- `is_repair_canonical` (BOOLEAN)## Пошаговая инструкция для создания метрик в Metabase### Шаг 1: Подключение базы данныхУбедитесь, что база данных подключена и синхронизирована:1. Admin → Databases → ABC Metrics Production2. Нажмите "Sync database schema now"3. Дождитесь завершения синхронизации### Шаг 2: Создание вопросов (Questions) на основе готовых Views#### Пример 1: Дневные метрики за последний месяц**Действия:**1. Нажмите "New" → "Question" → "Native query"2. Выберите базу данных "ABC Metrics Production"3. Вставьте SQL:qlSELECT   d AS date,  source,  segment,  leads,  units,  repairs,  net_revenue,  total_cost,  ROUND(100.0 * conv_l_r, 2) AS conv_to_repair_pct,  cplFROM vw_daily_metrics WHERE d >= CURRENT_DATE - INTERVAL '30 days'ORDER BY d DESC, source, segment;4. Нажмите "Preview" для проверки5. Нажмите "Save" → дайте название "Daily Metrics - Last 30 Days"#### Пример 2: Эффективность техников за последние 3 месяцаSELECT   technician_name,  month_start,  total_jobs,  repairs_count,  gross_revenue,  avg_revenue_per_job,  ROUND(100.0 * same_day_rate, 2) AS same_day_rate_pctFROM mart_tech_mtdWHERE month_start >= DATE_TRUNC('month', CURRENT_DATE - INTERVAL '3 months')  AND technician_name IS NOT NULLORDER BY month_start DESC, gross_revenue DESC;#### Пример 3: Прогноз прибыли на текущий месяцSELECT   month_start,  mtd_revenue,  mtd_expenses,  mtd_profit,  avg_daily_profit_14d,  projected_profit,  ROUND(100.0 * (projected_profit - mtd_profit) / NULLIF(ABS(mtd_profit), 0), 2) AS forecast_variance_pctFROM mart_profit_mtd_v2ORDER BY month_start DESC;#### Пример 4: Воронка конверсии по каналамSELECT   channel_name,  month_start,  leads_total,  diagnostics_booked,  repairs_completed,  ROUND(100.0 * diagnostics_booked / NULLIF(leads_total, 0), 2) AS conv_to_diagnostic_pct,  ROUND(100.0 * repairs_completed / NULLIF(leads_total, 0), 2) AS conv_to_repair_pctFROM mart_lead_funnel_mtdWHERE month_start >= DATE_TRUNC('month', CURRENT_DATE - INTERVAL '3 months')ORDER BY month_start DESC, channel_name;#### Пример 5: Эффективность каналов (CPL, ROI)SELECT   channel_name,  month_start,  total_leads,  valid_leads,  total_spend,  repairs_completed,  cost_per_valid_lead,  cost_per_repair,  ROUND(100.0 * valid_leads / NULLIF(total_leads, 0), 2) AS valid_leads_rateFROM mart_channel_mtdWHERE month_start >= DATE_TRUNC('month', CURRENT_DATE - INTERVAL '6 months')ORDER BY month_start DESC, channel_name;#### Пример 6: Теплокарта (для Map визуализации)SELECT   zip,  lat,  lon,  SUM(job_count) as total_jobs,  SUM(total_revenue) as total_revenueFROM mart_zip_mtdWHERE month_start >= DATE_TRUNC('month', CURRENT_DATE - INTERVAL '3 months')  AND lat IS NOT NULL   AND lon IS NOT NULLGROUP BY zip, lat, lonORDER BY total_revenue DESC;#### Пример 7: Месячные метрики по источникамSELECT   month_start,  source,  SUM(leads) as total_leads,  SUM(units) as total_units,  SUM(repairs) as total_repairs,  SUM(net_revenue) as total_revenue,  SUM(cost) as total_cost,  SUM(net_revenue) - SUM(cost) as profit,  ROUND(AVG(conv_l_r) * 100, 2) as avg_conv_to_repair_pct,  ROUND(AVG(cpl), 2) as avg_cplFROM vw_monthly_metricsWHERE month_start >= DATE_TRUNC('month', CURRENT_DATE - INTERVAL '6 months')GROUP BY month_start, sourceORDER BY month_start DESC, source;#### Пример 8: Profit & Loss по дням (график)SELECT   d AS date,  gross_revenue,  total_expenses,  net_profitFROM mart_profit_mtdWHERE d >= CURRENT_DATE - INTERVAL '30 days'ORDER BY d;### Шаг 3: Настройка визуализаций#### Для временных рядов (графики):1. После создания вопроса выберите тип визуализации "Line" или "Area"2. X-axis: `date` или `month_start`3. Y-axis: выберите метрику (revenue, profit, leads и т.д.)4. Series: выберите `source` или `segment` для группировки#### Для таблиц:1. Тип визуализации "Table"2. Настройте форматирование колонок:   - Деньги: Format → Currency → USD   - Проценты: Format → Percentage   - Даты: Format → Date#### Для теплокарты:1. Тип визуализации "Map"2. Latitude: `lat`3. Longitude: `lon`4. Size: `total_revenue` или `job_count`### Шаг 4: Создание Dashboard1. Нажмите "New" → "Dashboard"2. Дайте название (например, "ABC Metrics - Executive Dashboard")3. Добавьте сохраненные вопросы через кнопку "+" или "Add question"4. Расположите карточки на дашборде5. Настройте фильтры (если нужно):   - Дата: переменная `{{date}}`   - Источник: переменная `{{source}}`## Рекомендуемые Dashboard### 1. Executive Dashboard**Вопросы:**- Прогноз прибыли (`mart_profit_mtd_v2`)- Месячные метрики по источникам (`vw_monthly_metrics`)- Динамика прибыли по дням (`mart_profit_mtd`)### 2. Marketing Dashboard**Вопросы:**- Эффективность каналов (`mart_channel_mtd`)- Воронка конверсии (`mart_lead_funnel_mtd`)- Дневные метрики (`vw_daily_metrics`)### 3. Operations Dashboard**Вопросы:**- Эффективность техников (`mart_tech_mtd`)- Теплокарта (`mart_zip_mtd`)- Статистика работ (`stg_jobs`)## Дополнительные метрики из таблиц (не views)### Звонки (таблица `calls`)qlSELECT   DATE_TRUNC('month', date) as month,  COUNT(*) as total_calls,  SUM(CASE WHEN answered = 'Yes' THEN 1 ELSE 0 END) as answered_calls,  ROUND(100.0 * SUM(CASE WHEN answered = 'Yes' THEN 1 ELSE 0 END) / COUNT(*), 2) as answer_rate,  AVG(duration) as avg_duration_secondsFROM callsWHERE date >= DATE_TRUNC('month', CURRENT_DATE - INTERVAL '3 months')GROUP BY DATE_TRUNC('month', date)ORDER BY month DESC;### Rate Me метрикиSELECT   DATE_TRUNC('month', created_at) as month,  COUNT(*) as tokens_sent,  SUM(CASE WHEN status = 'used' THEN 1 ELSE 0 END) as reviews_completed,  ROUND(100.0 * SUM(CASE WHEN status = 'used' THEN 1 ELSE 0 END) / COUNT(*), 2) as completion_rateFROM job_tokensWHERE created_at >= DATE_TRUNC('month', CURRENT_DATE - INTERVAL '6 months')GROUP BY DATE_TRUNC('month', created_at)ORDER BY month DESC;### Google Ads метрикиlSELECT   date,  campaign,  amount as spend,  impressions,  clicks,  ROUND(100.0 * clicks / NULLIF(impressions, 0), 2) as ctr,  ROUND(amount / NULLIF(clicks, 0), 2) as cost_per_clickFROM google_spendWHERE date >= CURRENT_DATE - INTERVAL '30 days'ORDER BY date DESC;## Полезные советы1. **Используйте готовые views** - они уже оптимизированы и содержат готовые агрегации2. **Кэширование** - включите кэширование для часто используемых вопросов (Admin → Settings → Caching)3. **Параметры** - используйте переменные для фильтров: `WHERE d >= {{start_date}}`4. **Алиасы** - переименовывайте колонки для лучшей читаемости: `ROUND(conv_l_r * 100, 2) AS conversion_rate_pct`5. **Форматирование** - настраивайте формат отображения чисел и дат в настройках визуализации## Проверка доступности ViewsЕсли views не видны в Metabase, проверьте:-- Выполните в Metabase SQL EditorSELECT table_name FROM information_schema.views WHERE table_schema = 'public'ORDER BY table_name;Должны быть видны:- `vw_daily_metrics`- `vw_monthly_metrics`- `vw_job_metrics`- `mart_profit_mtd`- `mart_profit_mtd_v2`- `mart_tech_mtd`- `mart_zip_mtd`- `mart_channel_mtd`- `mart_lead_funnel_mtd`- `stg_jobs`## Следующие шагиПосле создания базовых метрик можно:1. Добавить вычисляемые метрики (Custom Metrics в Metabase)2. Создать сегменты для группировки3. Настроить алерты на критические показатели4. Экспортировать данные для внешней аналитики
Нажмите "Preview" для проверки
Нажмите "Save" → дайте название "Daily Metrics - Last 30 Days"
Пример 2: Эффективность техников за последние 3 месяца
SELECT   technician_name,  month_start,  total_jobs,  repairs_count,  gross_revenue,  avg_revenue_per_job,  ROUND(100.0 * same_day_rate, 2) AS same_day_rate_pctFROM mart_tech_mtdWHERE month_start >= DATE_TRUNC('month', CURRENT_DATE - INTERVAL '3 months')  AND technician_name IS NOT NULLORDER BY month_start DESC, gross_revenue DESC;
Пример 3: Прогноз прибыли на текущий месяц
SELECT   month_start,  mtd_revenue,  mtd_expenses,  mtd_profit,  avg_daily_profit_14d,  projected_profit,  ROUND(100.0 * (projected_profit - mtd_profit) / NULLIF(ABS(mtd_profit), 0), 2) AS forecast_variance_pctFROM mart_profit_mtd_v2ORDER BY month_start DESC;
Пример 4: Воронка конверсии по каналам
SELECT   channel_name,  month_start,  leads_total,  diagnostics_booked,  repairs_completed,  ROUND(100.0 * diagnostics_booked / NULLIF(leads_total, 0), 2) AS conv_to_diagnostic_pct,  ROUND(100.0 * repairs_completed / NULLIF(leads_total, 0), 2) AS conv_to_repair_pctFROM mart_lead_funnel_mtdWHERE month_start >= DATE_TRUNC('month', CURRENT_DATE - INTERVAL '3 months')ORDER BY month_start DESC, channel_name;
Пример 5: Эффективность каналов (CPL, ROI)
SELECT   channel_name,  month_start,  total_leads,  valid_leads,  total_spend,  repairs_completed,  cost_per_valid_lead,  cost_per_repair,  ROUND(100.0 * valid_leads / NULLIF(total_leads, 0), 2) AS valid_leads_rateFROM mart_channel_mtdWHERE month_start >= DATE_TRUNC('month', CURRENT_DATE - INTERVAL '6 months')ORDER BY month_start DESC, channel_name;
Пример 6: Теплокарта (для Map визуализации)
SELECT   zip,  lat,  lon,  SUM(job_count) as total_jobs,  SUM(total_revenue) as total_revenueFROM mart_zip_mtdWHERE month_start >= DATE_TRUNC('month', CURRENT_DATE - INTERVAL '3 months')  AND lat IS NOT NULL   AND lon IS NOT NULLGROUP BY zip, lat, lonORDER BY total_revenue DESC;
Пример 7: Месячные метрики по источникам
SELECT   month_start,  source,  SUM(leads) as total_leads,  SUM(units) as total_units,  SUM(repairs) as total_repairs,  SUM(net_revenue) as total_revenue,  SUM(cost) as total_cost,  SUM(net_revenue) - SUM(cost) as profit,  ROUND(AVG(conv_l_r) * 100, 2) as avg_conv_to_repair_pct,  ROUND(AVG(cpl), 2) as avg_cplFROM vw_monthly_metricsWHERE month_start >= DATE_TRUNC('month', CURRENT_DATE - INTERVAL '6 months')GROUP BY month_start, sourceORDER BY month_start DESC, source;
Пример 8: Profit & Loss по дням (график)
SELECT   d AS date,  gross_revenue,  total_expenses,  net_profitFROM mart_profit_mtdWHERE d >= CURRENT_DATE - INTERVAL '30 days'ORDER BY d;
Шаг 3: Настройка визуализаций
Для временных рядов (графики):
После создания вопроса выберите тип визуализации "Line" или "Area"
X-axis: date или month_start
Y-axis: выберите метрику (revenue, profit, leads и т.д.)
Series: выберите source или segment для группировки
Для таблиц:
Тип визуализации "Table"
Настройте форматирование колонок:
Деньги: Format → Currency → USD
Проценты: Format → Percentage
Даты: Format → Date
Для теплокарты:
Тип визуализации "Map"
Latitude: lat
Longitude: lon
Size: total_revenue или job_count
Шаг 4: Создание Dashboard
Нажмите "New" → "Dashboard"
Дайте название (например, "ABC Metrics - Executive Dashboard")
Добавьте сохраненные вопросы через кнопку "+" или "Add question"
Расположите карточки на дашборде
Настройте фильтры (если нужно):
Дата: переменная {{date}}
Источник: переменная {{source}}
Рекомендуемые Dashboard
1. Executive Dashboard
Вопросы:
Прогноз прибыли (mart_profit_mtd_v2)
Месячные метрики по источникам (vw_monthly_metrics)
Динамика прибыли по дням (mart_profit_mtd)
2. Marketing Dashboard
Вопросы:
Эффективность каналов (mart_channel_mtd)
Воронка конверсии (mart_lead_funnel_mtd)
Дневные метрики (vw_daily_metrics)
3. Operations Dashboard
Вопросы:
Эффективность техников (mart_tech_mtd)
Теплокарта (mart_zip_mtd)
Статистика работ (stg_jobs)
Дополнительные метрики из таблиц (не views)
Звонки (таблица calls)
SELECT   DATE_TRUNC('month', date) as month,  COUNT(*) as total_calls,  SUM(CASE WHEN answered = 'Yes' THEN 1 ELSE 0 END) as answered_calls,  ROUND(100.0 * SUM(CASE WHEN answered = 'Yes' THEN 1 ELSE 0 END) / COUNT(*), 2) as answer_rate,  AVG(duration) as avg_duration_secondsFROM callsWHERE date >= DATE_TRUNC('month', CURRENT_DATE - INTERVAL '3 months')GROUP BY DATE_TRUNC('month', date)ORDER BY month DESC;
Rate Me метрики
SELECT   DATE_TRUNC('month', created_at) as month,  COUNT(*) as tokens_sent,  SUM(CASE WHEN status = 'used' THEN 1 ELSE 0 END) as reviews_completed,  ROUND(100.0 * SUM(CASE WHEN status = 'used' THEN 1 ELSE 0 END) / COUNT(*), 2) as completion_rateFROM job_tokensWHERE created_at >= DATE_TRUNC('month', CURRENT_DATE - INTERVAL '6 months')GROUP BY DATE_TRUNC('month', created_at)ORDER BY month DESC;
Google Ads метрики
SELECT   date,  campaign,  amount as spend,  impressions,  clicks,  ROUND(100.0 * clicks / NULLIF(impressions, 0), 2) as ctr,  ROUND(amount / NULLIF(clicks, 0), 2) as cost_per_clickFROM google_spendWHERE date >= CURRENT_DATE - INTERVAL '30 days'ORDER BY date DESC;
