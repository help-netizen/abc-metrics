# История изменений проекта ABC Metrics

Документ описывает основные изменения в проекте: что меняли, когда и зачем.

**Важно для агентов:** Перед любыми изменениями кода обязательно ознакомьтесь с этим документом, чтобы понять контекст и причины предыдущих изменений.

---

## Формат записей

Каждая запись содержит:
- **Дата** - когда было сделано изменение (если известно)
- **Описание** - краткое описание изменения (2-3 строки)
- **Затронутые файлы** - список измененных файлов/модулей

---

## 2025: Настройка системы агентов

### Создание документации для rely-lead-processor
- **Дата:** 2025-12-15
- **Описание:** Создана полная документация для агентов, работающих с `rely-lead-processor`, о работе с `abc-metrics` DB API и перенесенных эндпоинтах синхронизации. Документация включает основной гайд по работе с API через `AbcMetricsClient`, детальное описание всех DB API эндпоинтов (READ/WRITE/Batch/Aggregation) и описание эндпоинтов metrics module (test и sync endpoints). Документация подчеркивает архитектурные принципы (нет прямых подключений к БД из rely-lead-processor) и содержит примеры использования.
- **Затронутые файлы:**
  - `docs/rely-lead-processor/abc-metrics-api-guide.md` - основной гайд по работе с API
  - `docs/rely-lead-processor/db-api-endpoints.md` - описание всех DB API эндпоинтов
  - `docs/rely-lead-processor/metrics-endpoints.md` - описание эндпоинтов metrics module
  - `docs/requirements.md` - добавлена фича F052
  - `docs/architecture.md` - добавлен раздел о документации
  - `docs/tasks.md` - добавлены задачи F052-1, F052-2, F052-3
  - `docs/changelog.md` - добавлена запись об изменениях

### Уточнение архитектуры работы с БД
- **Дата:** 2025-12-14
- **Описание:** Уточнена документация архитектуры для разъяснения правил использования прямого подключения к БД. Документировано, что `abc-metrics` (DB API приложение) может и должно использовать прямое подключение к БД через `DATABASE_URL` и `pool`, в то время как `rely-lead-processor` (приложение синхронизации) НЕ должен использовать прямое подключение и должен использовать только REST API через `AbcMetricsClient`. Добавлены проверки подключения к БД в `workiz.service.ts` для улучшения обработки ошибок.
- **Затронутые файлы:**
  - `docs/architecture.md` - добавлены разделы о подключении к БД в `abc-metrics` и `rely-lead-processor`
  - `docs/architecture-principles.md` - уточнены принципы разделения с явным указанием, где допустимо прямое подключение
  - `src/services/workiz.service.ts` - добавлены проверки `DATABASE_URL` и улучшена обработка ошибок подключения

### Реализация Rate Me API и защита токенов
- **Дата:** 2025-12-10
- **Описание:** Реализован полный Rate Me API согласно requirements-db-app.md. Созданы таблицы: job_tokens (без FOREIGN KEY для защиты от удаления при синхронизации), referral_links, referral_shares, rewards, rate_me_events. Реализованы все API endpoints (/api/v1/jobs, /api/v1/job-tokens), аутентификация через API ключ, rate limiting, генерация JWT токенов. Таблица job_tokens не имеет жесткой связи с fact_jobs - связь только логическая через job_uuid для защиты токенов от случайного удаления.
- **Затронутые файлы:**
  - `src/db/migrate.ts` - таблицы Rate Me, автоматическое удаление FOREIGN KEY
  - `src/services/rate-me-token.service.ts` - новый сервис JWT токенов
  - `src/middleware/auth.middleware.ts` - аутентификация
  - `src/middleware/rate-limit.middleware.ts` - rate limiting
  - `src/api/rate-me-routes.ts` - API endpoints
  - `package.json` - jsonwebtoken, express-rate-limit
  - `RATE_ME_API_DOCS.md`, `RATE_ME_SETUP.md` - документация

### Добавление новых столбцов в fact_jobs и обновление веб-интерфейса
- **Дата:** 2025-01-XX
- **Описание:** Добавлены новые столбцы в таблицу fact_jobs для отображения дополнительной информации о работах: SerialId, TechnicianName (из Team[0].Name), JobAmountDue, JobTotalPrice, JobEndDateTime, LastStatusUpdate. Столбцы created_at и scheduled_at скрыты в веб-интерфейсе (table.html), но остаются в БД для агрегаций. Обновлены миграция, сервис синхронизации (svc-workiz-jobs.ts) и API endpoints. Веб-интерфейс теперь показывает только нужные столбцы с возможностью сортировки.
- **Затронутые файлы:**
  - `src/db/migrate.ts` - добавлена логика ALTER TABLE для новых столбцов
  - `src/services/svc-workiz-jobs.ts` - извлечение и сохранение новых полей из raw_data
  - `src/api/routes.ts` - обновлены endpoints /api/jobs и /api/table/:tableName для фактов работы
  - `public/app.js` - сортировка таблиц уже реализована ранее

### Исправление SSL конфигурации для подключения к PostgreSQL
- **Дата:** 2025-01-XX
- **Описание:** Исправлена логика определения SSL конфигурации при подключении к PostgreSQL. Приложение автоматически определяет тип подключения (внутреннее Fly.io flycast или внешнее) и применяет соответствующую конфигурацию SSL. Для внутренних подключений SSL отключается, для внешних используется relaxed SSL валидация (rejectUnauthorized: false), что позволяет работать с самоподписанными сертификатами при сохранении шифрования трафика. Добавлено подробное логирование для диагностики проблем с подключением.
- **Затронутые файлы:**
  - `src/db/connection.ts` - улучшена функция getSslConfig() с детальным логированием
  - `DEPLOY.md` - добавлена секция с инструкциями по устранению проблем с SSL

### Добавление сортировки таблиц в веб-интерфейсе
- **Дата:** 2025-01-XX
- **Описание:** Добавлена клиентская сортировка таблиц по столбцам в веб-интерфейсе просмотра БД. При клике на заголовок столбца таблица сортируется (возрастание/убывание), с визуальными индикаторами направления сортировки. Поддерживается сортировка чисел, дат, строк и обработка NULL значений.
- **Затронутые файлы:**
  - `public/app.js` - добавлена функция сортировки и обработчики кликов на заголовки
  - `public/style.css` - добавлены стили для индикаторов сортировки и hover эффектов

### Создание документации по синхронизации Jobs из Workiz
- **Дата:** 2025-01-XX
- **Описание:** Создан документ WORKIZ_JOBS_SYNC.md с детальным описанием процесса обновления jobs из Workiz API. Документ описывает архитектуру, методы синхронизации, пагинацию, нормализацию данных, сохранение в БД, примеры использования, обработку ошибок и ограничения.
- **Затронутые файлы:**
  - `WORKIZ_JOBS_SYNC.md` - новый файл с документацией

### Первичная подготовка проекта для работы агентов
- **Дата:** 2025-01-XX
- **Описание:** Завершена первичная подготовка проекта для работы системы агентов. Создана полная базовая документация (requirements.md, architecture.md, tasks.md, changelog.md) как source of truth. Подготовлены инструкции для всех агентов. Создан документ AGENTS_SETUP.md с описанием workflow и правил работы агентов. Проект готов к использованию агентов согласно их инструкциям.
- **Затронутые файлы:**
  - `docs/requirements.md` - создан, содержит 35+ функций с ID, статусами и реализацией
  - `docs/architecture.md` - создан, описывает модули, ответственность, сущности БД
  - `docs/tasks.md` - создан, содержит активные задачи и TODO
  - `docs/changelog.md` - создан, содержит историю изменений проекта
  - `docs/AGENTS_SETUP.md` - создан, описывает настройку и workflow агентов
  - `docs/agents/` - проверены все инструкции агентов

---

## 2024-2025: Основные изменения

### Миграция на Star Schema (Fact/Dim таблицы)
- **Дата:** ~2024-2025 (не указана точно)
- **Описание:** Рефакторинг структуры БД с переходом на нормализованную Star Schema. Добавлены fact таблицы (fact_leads, fact_jobs, fact_payments) и dimension таблицы (dim_source, dim_date) для улучшения производительности и гибкости запросов. Legacy таблицы сохранены для обратной совместимости.
- **Затронутые файлы:**
  - `src/db/migrate.ts` - создание fact/dim таблиц и индексов
  - Все сервисы синхронизации - добавлена поддержка записи в fact таблицы
  - `src/services/aggregation.service.ts` - использование fact таблиц для расчетов

---

### Универсальная таблица leads (ARCHITECTURE_UPDATE.md)
- **Дата:** ~2024 (не указана точно)
- **Описание:** Объединение всех лидов из Workiz в единую таблицу `leads` вместо отдельных таблиц для каждого источника. Упрощает работу с лидами из разных источников (Pro Referral, Google, Website) через единый интерфейс. Удален endpoint `/api/leads/proref`, добавлен универсальный `/api/leads`.
- **Затронутые файлы:**
  - `src/db/migrate.ts` - создание универсальной таблицы `leads`
  - `src/services/svc-workiz-leads.ts` - обновлена логика сохранения лидов
  - `src/services/aggregation.service.ts` - обновлены запросы для подсчета Pro Referral leads
  - `src/api/routes.ts` - удален `/api/leads/proref`, добавлен `/api/leads`
  - `src/services/csv.service.ts` - убрана обработка файлов `proref_leads`

---

### Интеграция Elocal Calls через Puppeteer (ELOCAL_SYNC_IMPLEMENTATION.md)
- **Дата:** ~2024-2025 (не указана точно)
- **Описание:** Реализована синхронизация звонков из elocal.com через веб-скрапинг с помощью Puppeteer, так как elocal.com не предоставляет публичного API. Автоматическая авторизация через форму логина, загрузка CSV через export URL, парсинг и сохранение в БД. Расписание: каждый день в 4:00 AM (последние 30 дней).
- **Затронутые файлы:**
  - `src/services/svc-elocal-calls.ts` - новый сервис для синхронизации Elocal Calls
  - `src/scheduler.ts` - добавлен cron для синхронизации Elocal Calls
  - `src/api/routes.ts` - добавлены тестовые endpoints для Elocal Calls
  - `src/db/migrate.ts` - таблица `calls` с поддержкой источника 'elocals'
  - Добавлены env vars: `ELOCAL_USERNAME`, `ELOCAL_PASSWORD`

---

### Добавление VIEW для расчетов метрик
- **Дата:** ~2024-2025 (не указана точно)
- **Описание:** Созданы SQL VIEW для упрощения расчетов метрик (units, repairs, revenue). `vw_job_metrics` определяет is_unit и is_repair для каждого job, `vw_daily_metrics` и `vw_monthly_metrics` агрегируют метрики. Упрощает запросы в AggregationService и повышает производительность.
- **Затронутые файлы:**
  - `src/db/migrate.ts` - создание VIEW: vw_job_metrics, vw_daily_metrics, vw_monthly_metrics
  - `src/services/aggregation.service.ts` - использование VIEW вместо прямых запросов

---

### Разделение сервисов Workiz на отдельные классы
- **Дата:** ~2024-2025 (не указана точно)
- **Описание:** Рефакторинг WorkizService - разделение на отдельные сервисы для каждого типа данных (Jobs, Leads, Payments). Созданы SvcWorkizJobs, SvcWorkizLeads, SvcWorkizPayments для улучшения модульности и поддержки независимой синхронизации.
- **Затронутые файлы:**
  - `src/services/svc-workiz-jobs.ts` - новый сервис для Jobs
  - `src/services/svc-workiz-leads.ts` - новый сервис для Leads
  - `src/services/svc-workiz-payments.ts` - новый сервис для Payments
  - `src/services/workiz.service.ts` - базовый сервис с общими методами
  - `src/scheduler.ts` - обновлены вызовы сервисов

---

### Добавление тестовых API endpoints
- **Дата:** ~2024-2025 (не указана точно)
- **Описание:** Добавлены тестовые endpoints для отладки синхронизации данных. Позволяют получать данные без сохранения в БД, запускать ручную синхронизацию, тестировать аутентификацию. Упрощает разработку и отладку интеграций.
- **Затронутые файлы:**
  - `src/api/routes.ts` - добавлены тестовые endpoints:
    - `/api/test/workiz/jobs`, `/api/test/workiz/leads`, `/api/test/workiz/payments`
    - `/api/test/elocal/calls`
    - `/api/test/csv/process`
    - Endpoints для ручной синхронизации (`/sync`, `/sync-full`)

---

### Web интерфейс для просмотра БД
- **Дата:** ~2024-2025 (не указана точно)
- **Описание:** Добавлен веб-интерфейс для просмотра данных БД через браузер. Endpoints `/api/tables` и `/api/table/:tableName` для получения списка таблиц и их содержимого. Статические файлы в `public/` для веб-интерфейса.
- **Затронутые файлы:**
  - `src/api/routes.ts` - endpoints `/api/tables`, `/api/table/:tableName`
  - `public/index.html`, `public/app.js`, `public/style.css` - веб-интерфейс
  - `src/metrics-collector.ts` - настройка static files serving

---

### Добавление CORS и поддержки JSON API
- **Дата:** ~2024-2025 (не указана точно)
- **Описание:** Настройка CORS для доступа к API из браузера и поддержка JSON формата для всех endpoints. Позволяет использовать API в дашбордах и веб-приложениях.
- **Затронутые файлы:**
  - `src/metrics-collector.ts` - CORS middleware, JSON parser
  - Все endpoints в `src/api/routes.ts` - возвращают JSON

---

### Реализация полной переагрегации метрик
- **Дата:** ~2024-2025 (не указана точно)
- **Описание:** Добавлена задача полной переагрегации всех метрик (ежедневно в 3:00 AM). Позволяет пересчитывать метрики с начала данных для исправления ошибок и корректировки данных после изменений в исходных данных.
- **Затронутые файлы:**
  - `src/services/aggregation.service.ts` - методы `aggregateAllDailyMetrics()`, `aggregateAllMonthlyMetrics()`
  - `src/scheduler.ts` - cron для полной переагрегации

---

### Миграция на TypeScript
- **Дата:** Начало проекта
- **Описание:** Проект изначально разработан на TypeScript для улучшения типизации и поддержки кода. Компиляция в JavaScript для production через `npm run build`.
- **Затронутые файлы:**
  - Все файлы в `src/` - TypeScript
  - `tsconfig.json` - конфигурация TypeScript
  - `package.json` - скрипты сборки и разработки

---

### Настройка автоматических миграций БД
- **Дата:** ~2024-2025 (не указана точно)
- **Описание:** Миграции БД запускаются автоматически при старте приложения. Обеспечивает актуальность структуры БД без ручного вмешательства. Миграции идемпотентны - можно запускать многократно.
- **Затронутые файлы:**
  - `src/metrics-collector.ts` - вызов `migrate()` при старте
  - `src/db/migrate.ts` - использование транзакций для безопасности

---

### Добавление Graceful Shutdown
- **Дата:** ~2024-2025 (не указана точно)
- **Описание:** Реализована обработка сигналов SIGTERM/SIGINT для корректного завершения работы приложения. Закрывает подключения к БД перед завершением процесса.
- **Затронутые файлы:**
  - `src/metrics-collector.ts` - обработчики SIGTERM/SIGINT

---

### Добавление поддержки CSV обработки
- **Дата:** ~2024-2025 (не указана точно)
- **Описание:** Реализована автоматическая обработка CSV файлов из указанной директории. Определение типа данных по имени файла, парсинг и сохранение в соответствующие таблицы. Расписание: каждые 6 часов.
- **Затронутые файлы:**
  - `src/services/csv.service.ts` - новый сервис для обработки CSV
  - `src/scheduler.ts` - cron для обработки CSV файлов
  - Добавлена env var: `CSV_DIRECTORY`

---

## Известные даты из файлов проекта

### Создание документации Elocal Calls
- **Дата:** ~2024-2025
- **Описание:** Создан файл `ELOCAL_SYNC_IMPLEMENTATION.md` с детальным описанием реализации синхронизации Elocal Calls. Содержит информацию о методах, процессах, примерах использования и тестировании.

---

### Создание документации архитектуры
- **Дата:** ~2024
- **Описание:** Создан файл `ARCHITECTURE_UPDATE.md` с описанием изменений в архитектуре, связанных с универсальной таблицей leads. Содержит детали миграции данных и примеры использования.

---

## Примечания

- Многие даты не указаны точно, так как в проекте нет системы контроля версий с детальными коммитами
- Рекомендуется добавлять записи в этот changelog при каждом значимом изменении
- Формат дат: YYYY-MM-DD или ~YYYY для приблизительных дат
- При добавлении новых записей размещайте их в начале раздела (хронология от новых к старым)

---

### Исправление аутентификации веб-интерфейса (F053)
- **Дата:** 2025-12-15
- **Описание:** Исправлена ошибка 401 Unauthorized на главной странице веб-интерфейса. Публичные endpoints `/api/tables` и `/api/table/:name` перемещены перед монтированием `dbRoutes`, чтобы они не получали middleware аутентификации. DB API endpoints (`/api/db/*`) остаются защищенными.
- **Затронутые файлы:**
  - `src/api/routes.ts` - перемещены публичные endpoints веб-интерфейса перед `router.use(dbRoutes)`
  - `docs/requirements.md` - обновлен статус F020 на "⚠️ Частично (требуется исправление аутентификации)"
  - `docs/architecture.md` - добавлен раздел "Web Interface Endpoints (Public Access)"
  - `docs/tasks.md` - добавлена задача F053-1

## Шаблон для новых записей

```markdown
### Краткое описание изменения
- **Дата:** YYYY-MM-DD
- **Описание:** 2-3 строки описания того, что было изменено и зачем
- **Затронутые файлы:**
  - `path/to/file1.ts` - что изменилось
  - `path/to/file2.ts` - что изменилось
```

